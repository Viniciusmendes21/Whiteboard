{"ast":null,"code":"import { Subject, takeUntil } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../../services/canvas.service\";\nimport * as i2 from \"../../services/tool.service\";\nimport * as i3 from \"../../services/history.service\";\nimport * as i4 from \"@angular/common\";\nimport * as i5 from \"@angular/forms\";\nconst _c0 = [\"canvas\"];\nconst _c1 = [\"textEditor\"];\nconst _c2 = (a0, a1, a2, a3) => ({\n  top: a0,\n  left: a1,\n  width: a2,\n  height: a3\n});\nfunction CanvasComponent_textarea_3_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r2 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"textarea\", 5, 1);\n    i0.ɵɵtwoWayListener(\"ngModelChange\", function CanvasComponent_textarea_3_Template_textarea_ngModelChange_0_listener($event) {\n      i0.ɵɵrestoreView(_r2);\n      const ctx_r2 = i0.ɵɵnextContext();\n      i0.ɵɵtwoWayBindingSet(ctx_r2.editValue, $event) || (ctx_r2.editValue = $event);\n      return i0.ɵɵresetView($event);\n    });\n    i0.ɵɵlistener(\"keydown\", function CanvasComponent_textarea_3_Template_textarea_keydown_0_listener($event) {\n      i0.ɵɵrestoreView(_r2);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.onInlineEditKeydown($event));\n    })(\"blur\", function CanvasComponent_textarea_3_Template_textarea_blur_0_listener() {\n      i0.ɵɵrestoreView(_r2);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.commitInlineEdit());\n    })(\"mousedown\", function CanvasComponent_textarea_3_Template_textarea_mousedown_0_listener($event) {\n      i0.ɵɵrestoreView(_r2);\n      return i0.ɵɵresetView($event.stopPropagation());\n    });\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"ngStyle\", i0.ɵɵpureFunction4(2, _c2, ctx_r2.editPosition.top + \"px\", ctx_r2.editPosition.left + \"px\", ctx_r2.editPosition.width + \"px\", ctx_r2.editPosition.height + \"px\"));\n    i0.ɵɵtwoWayProperty(\"ngModel\", ctx_r2.editValue);\n  }\n}\nexport class CanvasComponent {\n  constructor(canvasService, toolService, historyService) {\n    this.canvasService = canvasService;\n    this.toolService = toolService;\n    this.historyService = historyService;\n    this.isDrawing = false;\n    this.startPoint = {\n      x: 0,\n      y: 0\n    };\n    this.currentElement = null;\n    this.destroy$ = new Subject();\n    this.isPanning = false;\n    this.lastPanPoint = {\n      x: 0,\n      y: 0\n    };\n    this.isDraggingSelection = false;\n    this.dragStartPoint = null;\n    this.dragInitialPositions = {};\n    this.isResizing = false;\n    this.resizeHandle = null;\n    this.resizeStartPoint = null;\n    this.resizeInitial = {\n      x: 0,\n      y: 0,\n      width: 0,\n      height: 0,\n      id: ''\n    };\n    this.handleSize = 10;\n    this.editingElementId = null;\n    this.editValue = '';\n    this.editPosition = {\n      top: 0,\n      left: 0,\n      width: 140,\n      height: 36\n    };\n  }\n  ngAfterViewInit() {\n    this.initCanvas();\n    this.setupSubscriptions();\n    this.render();\n  }\n  ngOnDestroy() {\n    this.destroy$.next();\n    this.destroy$.complete();\n  }\n  initCanvas() {\n    const canvas = this.canvasRef.nativeElement;\n    this.ctx = canvas.getContext('2d');\n    this.resizeCanvas();\n  }\n  setupSubscriptions() {\n    this.canvasService.elements$.pipe(takeUntil(this.destroy$)).subscribe(() => this.render());\n    this.canvasService.zoom$.pipe(takeUntil(this.destroy$)).subscribe(() => this.render());\n    this.canvasService.pan$.pipe(takeUntil(this.destroy$)).subscribe(() => this.render());\n  }\n  resizeCanvas() {\n    const canvas = this.canvasRef.nativeElement;\n    canvas.width = canvas.offsetWidth;\n    canvas.height = canvas.offsetHeight;\n    this.render();\n  }\n  handleKeyDown(event) {\n    if (event.ctrlKey && event.key === 'z') {\n      event.preventDefault();\n      const state = this.historyService.undo();\n      if (state) this.canvasService.setState(state);\n    } else if (event.ctrlKey && event.key === 'y') {\n      event.preventDefault();\n      const state = this.historyService.redo();\n      if (state) this.canvasService.setState(state);\n    } else if (event.key === 'Delete') {\n      event.preventDefault();\n      this.canvasService.deleteSelectedElements();\n      this.historyService.addState(this.canvasService.getState());\n    }\n  }\n  onDoubleClick(event) {\n    const point = this.getCanvasPoint(event, false);\n    const target = this.findTopElement(point);\n    if (target && target.text) {\n      this.startInlineEdit(target);\n    }\n  }\n  onMouseDown(event) {\n    const tool = this.toolService.currentTool;\n    const shouldSnap = this.canvasService.snapToGrid && tool !== 'select' && tool !== 'pan';\n    const point = this.getCanvasPoint(event, shouldSnap);\n    if (tool === 'pan') {\n      this.isPanning = true;\n      this.lastPanPoint = {\n        x: event.clientX,\n        y: event.clientY\n      };\n      return;\n    }\n    // Auto-seleciona elementos mesmo quando outra ferramenta está ativa\n    if (tool === 'select') {\n      const handleHit = this.hitHandle(point);\n      if (handleHit) {\n        this.isResizing = true;\n        this.resizeHandle = handleHit.handle;\n        this.resizeStartPoint = point;\n        this.resizeInitial = {\n          x: handleHit.element.x,\n          y: handleHit.element.y,\n          width: handleHit.element.width || this.measureElementWidth(handleHit.element),\n          height: handleHit.element.height || this.measureElementHeight(handleHit.element),\n          id: handleHit.element.id\n        };\n        return;\n      }\n    }\n    if (tool === 'select') {\n      const target = this.findTopElement(point);\n      if (target) {\n        if (!target.isSelected && !event.shiftKey) {\n          this.canvasService.clearSelection();\n        }\n        this.canvasService.selectElement(target.id, event.shiftKey);\n        this.startSelectionDrag(point);\n      } else {\n        if (!event.shiftKey) {\n          this.canvasService.clearSelection();\n        }\n        this.isDraggingSelection = false;\n      }\n      return;\n    }\n    this.isDrawing = true;\n    this.startPoint = point;\n    this.canvasService.clearSelection();\n    this.currentElement = {\n      id: this.canvasService.generateId(),\n      type: tool,\n      x: point.x,\n      y: point.y,\n      strokeColor: this.toolService.strokeColor,\n      fillColor: this.toolService.fillColor,\n      strokeWidth: this.toolService.strokeWidth,\n      fontSize: this.toolService.fontSize,\n      fontFamily: this.toolService.fontFamily,\n      fontStyle: this.toolService.fontStyle,\n      fontWeight: this.toolService.fontWeight,\n      rotation: 0,\n      points: tool === 'freedraw' ? [point] : []\n    };\n    if (tool === 'text') {\n      this.handleTextInput(point);\n    }\n  }\n  onMouseMove(event) {\n    if (this.isPanning) {\n      const dx = event.clientX - this.lastPanPoint.x;\n      const dy = event.clientY - this.lastPanPoint.y;\n      const pan = this.canvasService.pan;\n      this.canvasService.setPan({\n        x: pan.x + dx,\n        y: pan.y + dy\n      });\n      this.lastPanPoint = {\n        x: event.clientX,\n        y: event.clientY\n      };\n      return;\n    }\n    if (this.isDraggingSelection && this.dragStartPoint) {\n      const point = this.getCanvasPoint(event, this.canvasService.snapToGrid);\n      const dx = point.x - this.dragStartPoint.x;\n      const dy = point.y - this.dragStartPoint.y;\n      const size = this.canvasService.gridSize;\n      const updated = this.canvasService.elements.map(el => {\n        if (!el.isSelected) return el;\n        const base = this.dragInitialPositions[el.id] || {\n          x: el.x,\n          y: el.y\n        };\n        let x = base.x + dx;\n        let y = base.y + dy;\n        if (this.canvasService.snapToGrid) {\n          x = Math.round(x / size) * size;\n          y = Math.round(y / size) * size;\n        }\n        return {\n          ...el,\n          x,\n          y\n        };\n      });\n      this.canvasService.setElements(updated);\n      this.render();\n      return;\n    }\n    if (this.isResizing && this.resizeHandle && this.resizeStartPoint) {\n      const point = this.getCanvasPoint(event, false);\n      const dx = point.x - this.resizeStartPoint.x;\n      const dy = point.y - this.resizeStartPoint.y;\n      const el = this.canvasService.elements.find(e => e.id === this.resizeInitial.id);\n      if (!el) return;\n      let newX = this.resizeInitial.x;\n      let newY = this.resizeInitial.y;\n      let newW = this.resizeInitial.width || 0;\n      let newH = this.resizeInitial.height || 0;\n      const minSize = 10;\n      switch (this.resizeHandle) {\n        case 'se':\n          newW = Math.max(minSize, this.resizeInitial.width + dx);\n          newH = Math.max(minSize, this.resizeInitial.height + dy);\n          break;\n        case 'ne':\n          newW = Math.max(minSize, this.resizeInitial.width + dx);\n          newH = Math.max(minSize, this.resizeInitial.height - dy);\n          newY = this.resizeInitial.y + dy;\n          break;\n        case 'sw':\n          newW = Math.max(minSize, this.resizeInitial.width - dx);\n          newH = Math.max(minSize, this.resizeInitial.height + dy);\n          newX = this.resizeInitial.x + dx;\n          break;\n        case 'nw':\n          newW = Math.max(minSize, this.resizeInitial.width - dx);\n          newH = Math.max(minSize, this.resizeInitial.height - dy);\n          newX = this.resizeInitial.x + dx;\n          newY = this.resizeInitial.y + dy;\n          break;\n        case 'e':\n          newW = Math.max(minSize, this.resizeInitial.width + dx);\n          break;\n        case 'w':\n          newW = Math.max(minSize, this.resizeInitial.width - dx);\n          newX = this.resizeInitial.x + dx;\n          break;\n        case 's':\n          newH = Math.max(minSize, this.resizeInitial.height + dy);\n          break;\n        case 'n':\n          newH = Math.max(minSize, this.resizeInitial.height - dy);\n          newY = this.resizeInitial.y + dy;\n          break;\n      }\n      this.canvasService.updateElement(el.id, {\n        x: newX,\n        y: newY,\n        width: newW,\n        height: newH\n      });\n      return;\n    }\n    if (!this.isDrawing || !this.currentElement) return;\n    const tool = this.toolService.currentTool;\n    const shouldSnap = this.canvasService.snapToGrid && tool !== 'select' && tool !== 'pan';\n    const point = this.getCanvasPoint(event, shouldSnap);\n    if (tool === 'freedraw') {\n      this.currentElement.points.push(point);\n    } else {\n      this.currentElement.width = point.x - this.startPoint.x;\n      this.currentElement.height = point.y - this.startPoint.y;\n    }\n    this.render();\n    if (this.currentElement) {\n      this.drawElement(this.currentElement);\n    }\n  }\n  onMouseUp(event) {\n    if (this.isPanning) {\n      this.isPanning = false;\n      return;\n    }\n    if (this.isResizing) {\n      this.isResizing = false;\n      this.resizeHandle = null;\n      this.resizeStartPoint = null;\n      this.historyService.addState(this.canvasService.getState());\n      return;\n    }\n    if (this.isDraggingSelection) {\n      this.isDraggingSelection = false;\n      this.dragStartPoint = null;\n      this.dragInitialPositions = {};\n      this.historyService.addState(this.canvasService.getState());\n      return;\n    }\n    if (!this.isDrawing || !this.currentElement) return;\n    if (this.toolService.currentTool !== 'text') {\n      this.canvasService.addElement(this.currentElement);\n      this.historyService.addState(this.canvasService.getState());\n    }\n    this.isDrawing = false;\n    this.currentElement = null;\n  }\n  onWheel(event) {\n    if (event.ctrlKey) {\n      event.preventDefault();\n      const delta = event.deltaY > 0 ? 0.9 : 1.1;\n      this.canvasService.setZoom(this.canvasService.zoom * delta);\n    }\n  }\n  getCanvasPoint(event, snapToGrid = false) {\n    const canvas = this.canvasRef.nativeElement;\n    const rect = canvas.getBoundingClientRect();\n    const zoom = this.canvasService.zoom;\n    const pan = this.canvasService.pan;\n    let x = (event.clientX - rect.left - pan.x) / zoom;\n    let y = (event.clientY - rect.top - pan.y) / zoom;\n    if (snapToGrid && this.canvasService.snapToGrid) {\n      const size = this.canvasService.gridSize;\n      x = Math.round(x / size) * size;\n      y = Math.round(y / size) * size;\n    }\n    return {\n      x,\n      y\n    };\n  }\n  handleSelection(point, addToSelection) {\n    const elements = this.canvasService.elements;\n    for (let i = elements.length - 1; i >= 0; i--) {\n      const el = elements[i];\n      if (this.isPointInElement(point, el)) {\n        this.canvasService.selectElement(el.id, addToSelection);\n        return;\n      }\n    }\n    if (!addToSelection) {\n      this.canvasService.clearSelection();\n    }\n  }\n  isPointInElement(point, element) {\n    if (element.type === 'freedraw') {\n      return element.points?.some(p => Math.abs(p.x - point.x) < 10 && Math.abs(p.y - point.y) < 10) || false;\n    }\n    const x = element.x;\n    const y = element.y;\n    const w = element.width || 0;\n    const h = element.height || 0;\n    return point.x >= Math.min(x, x + w) && point.x <= Math.max(x, x + w) && point.y >= Math.min(y, y + h) && point.y <= Math.max(y, y + h);\n  }\n  handleTextInput(point) {\n    if (this.currentElement) {\n      const text = '';\n      this.currentElement.text = text;\n      this.currentElement.width = 100;\n      this.currentElement.height = this.measureElementHeight({\n        ...this.currentElement,\n        text\n      });\n      this.canvasService.addElement(this.currentElement);\n      this.canvasService.clearSelection();\n      this.canvasService.selectElement(this.currentElement.id, false);\n      this.startInlineEdit(this.currentElement);\n    }\n    this.isDrawing = false;\n    this.currentElement = null;\n  }\n  findTopElement(point) {\n    const elements = [...this.canvasService.elements].sort((a, b) => (a.zIndex ?? 0) - (b.zIndex ?? 0));\n    for (let i = elements.length - 1; i >= 0; i--) {\n      if (this.isPointInElement(point, elements[i])) {\n        return elements[i];\n      }\n    }\n    return null;\n  }\n  startSelectionDrag(point) {\n    this.isDraggingSelection = true;\n    this.dragStartPoint = point;\n    this.dragInitialPositions = {};\n    this.canvasService.elements.forEach(el => {\n      if (el.isSelected) {\n        this.dragInitialPositions[el.id] = {\n          x: el.x,\n          y: el.y\n        };\n      }\n    });\n  }\n  hitHandle(point) {\n    const selected = this.canvasService.elements.find(el => el.isSelected);\n    if (!selected) return null;\n    const bounds = this.getElementBounds(selected);\n    const hs = this.handleSize;\n    const handles = [{\n      handle: 'nw',\n      x: bounds.x - hs / 2,\n      y: bounds.y - hs / 2\n    }, {\n      handle: 'n',\n      x: bounds.x + bounds.width / 2 - hs / 2,\n      y: bounds.y - hs / 2\n    }, {\n      handle: 'ne',\n      x: bounds.x + bounds.width - hs / 2,\n      y: bounds.y - hs / 2\n    }, {\n      handle: 'w',\n      x: bounds.x - hs / 2,\n      y: bounds.y + bounds.height / 2 - hs / 2\n    }, {\n      handle: 'e',\n      x: bounds.x + bounds.width - hs / 2,\n      y: bounds.y + bounds.height / 2 - hs / 2\n    }, {\n      handle: 'sw',\n      x: bounds.x - hs / 2,\n      y: bounds.y + bounds.height - hs / 2\n    }, {\n      handle: 's',\n      x: bounds.x + bounds.width / 2 - hs / 2,\n      y: bounds.y + bounds.height - hs / 2\n    }, {\n      handle: 'se',\n      x: bounds.x + bounds.width - hs / 2,\n      y: bounds.y + bounds.height - hs / 2\n    }];\n    return handles.find(h => point.x >= h.x && point.x <= h.x + hs && point.y >= h.y && point.y <= h.y + hs) ? {\n      element: selected,\n      handle: handles.find(h => point.x >= h.x && point.x <= h.x + hs && point.y >= h.y && point.y <= h.y + hs).handle\n    } : null;\n  }\n  render() {\n    const canvas = this.canvasRef.nativeElement;\n    this.ctx.clearRect(0, 0, canvas.width, canvas.height);\n    this.ctx.save();\n    const zoom = this.canvasService.zoom;\n    const pan = this.canvasService.pan;\n    this.ctx.translate(pan.x, pan.y);\n    this.ctx.scale(zoom, zoom);\n    const elements = [...this.canvasService.elements].sort((a, b) => (a.zIndex ?? 0) - (b.zIndex ?? 0));\n    elements.forEach(element => {\n      this.drawElement(element);\n    });\n    const selected = elements.find(el => el.isSelected);\n    if (selected) {\n      const bounds = this.getElementBounds(selected);\n      this.drawSelectionHandles(bounds);\n    }\n    this.ctx.restore();\n  }\n  drawElement(element) {\n    this.ctx.save();\n    this.ctx.strokeStyle = element.strokeColor;\n    this.ctx.fillStyle = element.fillColor;\n    this.ctx.lineWidth = element.strokeWidth;\n    const centerX = element.x + (element.width || 0) / 2;\n    const centerY = element.y + (element.height || 0) / 2;\n    if (element.rotation) {\n      this.ctx.translate(centerX, centerY);\n      this.ctx.rotate(element.rotation * Math.PI / 180);\n      this.ctx.translate(-centerX, -centerY);\n    }\n    if (element.isSelected) {\n      this.ctx.strokeStyle = '#4CAF50';\n      this.ctx.lineWidth = element.strokeWidth + 2;\n    }\n    switch (element.type) {\n      case 'rectangle':\n        this.drawRectangle(element);\n        break;\n      case 'circle':\n        this.drawCircle(element);\n        break;\n      case 'ellipse':\n        this.drawEllipse(element);\n        break;\n      case 'line':\n        this.drawLine(element);\n        break;\n      case 'arrow':\n        this.drawArrow(element);\n        break;\n      case 'triangle':\n        this.drawTriangle(element);\n        break;\n      case 'star':\n        this.drawStar(element);\n        break;\n      case 'polygon':\n        this.drawPolygon(element);\n        break;\n      case 'freedraw':\n        this.drawFreeDraw(element);\n        break;\n      case 'text':\n        this.drawText(element);\n        break;\n    }\n    this.ctx.restore();\n  }\n  drawRectangle(element) {\n    const w = element.width || 0;\n    const h = element.height || 0;\n    this.ctx.fillRect(element.x, element.y, w, h);\n    this.ctx.strokeRect(element.x, element.y, w, h);\n  }\n  drawCircle(element) {\n    const radius = Math.abs(element.width || 0) / 2;\n    const centerX = element.x + (element.width || 0) / 2;\n    const centerY = element.y + (element.height || 0) / 2;\n    this.ctx.beginPath();\n    this.ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);\n    this.ctx.fill();\n    this.ctx.stroke();\n  }\n  drawEllipse(element) {\n    const radiusX = Math.abs(element.width || 0) / 2;\n    const radiusY = Math.abs(element.height || 0) / 2;\n    const centerX = element.x + (element.width || 0) / 2;\n    const centerY = element.y + (element.height || 0) / 2;\n    this.ctx.beginPath();\n    this.ctx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, Math.PI * 2);\n    this.ctx.fill();\n    this.ctx.stroke();\n  }\n  drawLine(element) {\n    const endX = element.x + (element.width || 0);\n    const endY = element.y + (element.height || 0);\n    this.ctx.beginPath();\n    this.ctx.moveTo(element.x, element.y);\n    this.ctx.lineTo(endX, endY);\n    this.ctx.stroke();\n  }\n  drawArrow(element) {\n    const endX = element.x + (element.width || 0);\n    const endY = element.y + (element.height || 0);\n    // Draw line\n    this.ctx.beginPath();\n    this.ctx.moveTo(element.x, element.y);\n    this.ctx.lineTo(endX, endY);\n    this.ctx.stroke();\n    // Draw arrowhead\n    const angle = Math.atan2(endY - element.y, endX - element.x);\n    const headLength = 15;\n    this.ctx.beginPath();\n    this.ctx.moveTo(endX, endY);\n    this.ctx.lineTo(endX - headLength * Math.cos(angle - Math.PI / 6), endY - headLength * Math.sin(angle - Math.PI / 6));\n    this.ctx.moveTo(endX, endY);\n    this.ctx.lineTo(endX - headLength * Math.cos(angle + Math.PI / 6), endY - headLength * Math.sin(angle + Math.PI / 6));\n    this.ctx.stroke();\n  }\n  drawFreeDraw(element) {\n    if (!element.points || element.points.length < 2) return;\n    this.ctx.beginPath();\n    this.ctx.moveTo(element.points[0].x, element.points[0].y);\n    for (let i = 1; i < element.points.length; i++) {\n      this.ctx.lineTo(element.points[i].x, element.points[i].y);\n    }\n    this.ctx.stroke();\n  }\n  drawText(element) {\n    if (!element.text) return;\n    const size = element.fontSize ?? 16;\n    const family = element.fontFamily ?? 'Arial';\n    const style = element.fontStyle ?? 'normal';\n    const weight = element.fontWeight ?? 'normal';\n    this.ctx.font = `${style} ${weight} ${size}px ${family}`;\n    this.ctx.fillStyle = element.strokeColor || '#000';\n    this.ctx.fillText(element.text, element.x, element.y + size);\n    if (element.isSelected) {\n      const boxW = element.width || this.ctx.measureText(element.text).width;\n      const boxH = element.height || size;\n      this.ctx.strokeRect(element.x - 2, element.y, boxW + 4, boxH + 4);\n    }\n  }\n  getElementBounds(el) {\n    if (el.type === 'text') {\n      const size = el.fontSize ?? 16;\n      const family = el.fontFamily ?? 'Arial';\n      const style = el.fontStyle ?? 'normal';\n      const weight = el.fontWeight ?? 'normal';\n      this.ctx.save();\n      this.ctx.font = `${style} ${weight} ${size}px ${family}`;\n      const width = el.width || this.ctx.measureText(el.text || '').width;\n      this.ctx.restore();\n      const height = el.height || size;\n      return {\n        x: el.x,\n        y: el.y,\n        width,\n        height\n      };\n    }\n    return {\n      x: el.x,\n      y: el.y,\n      width: el.width || 0,\n      height: el.height || 0\n    };\n  }\n  measureElementWidth(el) {\n    if (el.type === 'text') {\n      const size = el.fontSize ?? 16;\n      const family = el.fontFamily ?? 'Arial';\n      const style = el.fontStyle ?? 'normal';\n      const weight = el.fontWeight ?? 'normal';\n      this.ctx.save();\n      this.ctx.font = `${style} ${weight} ${size}px ${family}`;\n      const width = this.ctx.measureText(el.text || '').width;\n      this.ctx.restore();\n      return width;\n    }\n    return el.width || 0;\n  }\n  measureElementHeight(el) {\n    if (el.type === 'text') {\n      return el.height || el.fontSize || 16;\n    }\n    return el.height || 0;\n  }\n  drawSelectionHandles(bounds) {\n    const hs = this.handleSize;\n    const handles = [{\n      x: bounds.x - hs / 2,\n      y: bounds.y - hs / 2\n    }, {\n      x: bounds.x + bounds.width / 2 - hs / 2,\n      y: bounds.y - hs / 2\n    }, {\n      x: bounds.x + bounds.width - hs / 2,\n      y: bounds.y - hs / 2\n    }, {\n      x: bounds.x - hs / 2,\n      y: bounds.y + bounds.height / 2 - hs / 2\n    }, {\n      x: bounds.x + bounds.width - hs / 2,\n      y: bounds.y + bounds.height / 2 - hs / 2\n    }, {\n      x: bounds.x - hs / 2,\n      y: bounds.y + bounds.height - hs / 2\n    }, {\n      x: bounds.x + bounds.width / 2 - hs / 2,\n      y: bounds.y + bounds.height - hs / 2\n    }, {\n      x: bounds.x + bounds.width - hs / 2,\n      y: bounds.y + bounds.height - hs / 2\n    } // se\n    ];\n    this.ctx.save();\n    this.ctx.fillStyle = '#4CAF50';\n    this.ctx.strokeStyle = '#2e7d32';\n    handles.forEach(h => {\n      this.ctx.fillRect(h.x, h.y, hs, hs);\n      this.ctx.strokeRect(h.x, h.y, hs, hs);\n    });\n    this.ctx.restore();\n  }\n  startInlineEdit(el) {\n    const bounds = this.getElementBounds(el);\n    const zoom = this.canvasService.zoom;\n    const pan = this.canvasService.pan;\n    this.editingElementId = el.id;\n    this.editValue = el.text || '';\n    this.editPosition = {\n      top: bounds.y * zoom + pan.y,\n      left: bounds.x * zoom + pan.x,\n      width: Math.max(bounds.width, 100) * zoom,\n      height: Math.max(bounds.height, el.fontSize || 16) * zoom + 8\n    };\n    setTimeout(() => this.textEditorRef?.nativeElement.focus(), 0);\n  }\n  commitInlineEdit() {\n    if (!this.editingElementId) return;\n    const target = this.canvasService.elements.find(e => e.id === this.editingElementId);\n    if (!target) {\n      this.cancelInlineEdit();\n      return;\n    }\n    const text = this.editValue;\n    const width = this.measureElementWidth({\n      ...target,\n      text\n    });\n    const height = this.measureElementHeight({\n      ...target,\n      text\n    });\n    this.canvasService.updateElement(target.id, {\n      text,\n      width,\n      height\n    });\n    this.historyService.addState(this.canvasService.getState());\n    this.cancelInlineEdit();\n  }\n  cancelInlineEdit() {\n    this.editingElementId = null;\n    this.editValue = '';\n  }\n  onInlineEditKeydown(event) {\n    if (event.key === 'Enter' && !event.shiftKey) {\n      event.preventDefault();\n      this.commitInlineEdit();\n    }\n    if (event.key === 'Escape') {\n      event.preventDefault();\n      this.cancelInlineEdit();\n    }\n  }\n  drawTriangle(element) {\n    const w = element.width || 0;\n    const h = element.height || 0;\n    const x1 = element.x + w / 2;\n    const y1 = element.y;\n    const x2 = element.x + w;\n    const y2 = element.y + h;\n    const x3 = element.x;\n    const y3 = element.y + h;\n    this.ctx.beginPath();\n    this.ctx.moveTo(x1, y1);\n    this.ctx.lineTo(x2, y2);\n    this.ctx.lineTo(x3, y3);\n    this.ctx.closePath();\n    this.ctx.fill();\n    this.ctx.stroke();\n  }\n  drawStar(element, spikes = 5) {\n    const w = element.width || 0;\n    const h = element.height || 0;\n    const outerRadius = Math.max(Math.abs(w), Math.abs(h)) / 2;\n    const innerRadius = outerRadius / 2.5;\n    const centerX = element.x + w / 2;\n    const centerY = element.y + h / 2;\n    this.ctx.beginPath();\n    for (let i = 0; i < spikes * 2; i++) {\n      const radius = i % 2 === 0 ? outerRadius : innerRadius;\n      const angle = Math.PI / spikes * i - Math.PI / 2;\n      const x = centerX + Math.cos(angle) * radius;\n      const y = centerY + Math.sin(angle) * radius;\n      if (i === 0) {\n        this.ctx.moveTo(x, y);\n      } else {\n        this.ctx.lineTo(x, y);\n      }\n    }\n    this.ctx.closePath();\n    this.ctx.fill();\n    this.ctx.stroke();\n  }\n  drawPolygon(element, sides = 6) {\n    if (sides < 3) return;\n    const w = element.width || 0;\n    const h = element.height || 0;\n    const radius = Math.min(Math.abs(w), Math.abs(h)) / 2;\n    const centerX = element.x + w / 2;\n    const centerY = element.y + h / 2;\n    this.ctx.beginPath();\n    for (let i = 0; i < sides; i++) {\n      const angle = Math.PI * 2 / sides * i - Math.PI / 2;\n      const x = centerX + radius * Math.cos(angle);\n      const y = centerY + radius * Math.sin(angle);\n      if (i === 0) {\n        this.ctx.moveTo(x, y);\n      } else {\n        this.ctx.lineTo(x, y);\n      }\n    }\n    this.ctx.closePath();\n    this.ctx.fill();\n    this.ctx.stroke();\n  }\n  static {\n    this.ɵfac = function CanvasComponent_Factory(t) {\n      return new (t || CanvasComponent)(i0.ɵɵdirectiveInject(i1.CanvasService), i0.ɵɵdirectiveInject(i2.ToolService), i0.ɵɵdirectiveInject(i3.HistoryService));\n    };\n  }\n  static {\n    this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n      type: CanvasComponent,\n      selectors: [[\"app-canvas\"]],\n      viewQuery: function CanvasComponent_Query(rf, ctx) {\n        if (rf & 1) {\n          i0.ɵɵviewQuery(_c0, 5);\n          i0.ɵɵviewQuery(_c1, 5);\n        }\n        if (rf & 2) {\n          let _t;\n          i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.canvasRef = _t.first);\n          i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.textEditorRef = _t.first);\n        }\n      },\n      hostBindings: function CanvasComponent_HostBindings(rf, ctx) {\n        if (rf & 1) {\n          i0.ɵɵlistener(\"resize\", function CanvasComponent_resize_HostBindingHandler() {\n            return ctx.resizeCanvas();\n          }, false, i0.ɵɵresolveWindow)(\"keydown\", function CanvasComponent_keydown_HostBindingHandler($event) {\n            return ctx.handleKeyDown($event);\n          }, false, i0.ɵɵresolveWindow)(\"dblclick\", function CanvasComponent_dblclick_HostBindingHandler($event) {\n            return ctx.onDoubleClick($event);\n          })(\"wheel\", function CanvasComponent_wheel_HostBindingHandler($event) {\n            return ctx.onWheel($event);\n          });\n        }\n      },\n      decls: 4,\n      vars: 1,\n      consts: [[\"canvas\", \"\"], [\"textEditor\", \"\"], [1, \"canvas-container\"], [3, \"mousedown\", \"mousemove\", \"mouseup\"], [\"class\", \"text-editor\", \"spellcheck\", \"false\", 3, \"ngStyle\", \"ngModel\", \"ngModelChange\", \"keydown\", \"blur\", \"mousedown\", 4, \"ngIf\"], [\"spellcheck\", \"false\", 1, \"text-editor\", 3, \"ngModelChange\", \"keydown\", \"blur\", \"mousedown\", \"ngStyle\", \"ngModel\"]],\n      template: function CanvasComponent_Template(rf, ctx) {\n        if (rf & 1) {\n          const _r1 = i0.ɵɵgetCurrentView();\n          i0.ɵɵelementStart(0, \"div\", 2)(1, \"canvas\", 3, 0);\n          i0.ɵɵlistener(\"mousedown\", function CanvasComponent_Template_canvas_mousedown_1_listener($event) {\n            i0.ɵɵrestoreView(_r1);\n            return i0.ɵɵresetView(ctx.onMouseDown($event));\n          })(\"mousemove\", function CanvasComponent_Template_canvas_mousemove_1_listener($event) {\n            i0.ɵɵrestoreView(_r1);\n            return i0.ɵɵresetView(ctx.onMouseMove($event));\n          })(\"mouseup\", function CanvasComponent_Template_canvas_mouseup_1_listener($event) {\n            i0.ɵɵrestoreView(_r1);\n            return i0.ɵɵresetView(ctx.onMouseUp($event));\n          });\n          i0.ɵɵelementEnd();\n          i0.ɵɵtemplate(3, CanvasComponent_textarea_3_Template, 2, 7, \"textarea\", 4);\n          i0.ɵɵelementEnd();\n        }\n        if (rf & 2) {\n          i0.ɵɵadvance(3);\n          i0.ɵɵproperty(\"ngIf\", ctx.editingElementId);\n        }\n      },\n      dependencies: [i4.NgIf, i4.NgStyle, i5.DefaultValueAccessor, i5.NgControlStatus, i5.NgModel],\n      styles: [\".canvas-container[_ngcontent-%COMP%] {\\n  flex: 1;\\n  position: relative;\\n  overflow: hidden;\\n  background: var(--surface);\\n  background-image: linear-gradient(var(--grid-line, #e0e0e0) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line, #e0e0e0) 1px, transparent 1px);\\n  background-size: 20px 20px;\\n}\\n\\ncanvas[_ngcontent-%COMP%] {\\n  width: 100%;\\n  height: 100%;\\n  display: block;\\n  cursor: crosshair;\\n}\\n\\n.text-editor[_ngcontent-%COMP%] {\\n  position: absolute;\\n  padding: 8px 10px;\\n  border: 1px solid var(--accent);\\n  border-radius: 10px;\\n  background: rgba(255, 255, 255, 0.95);\\n  color: var(--text);\\n  font: inherit;\\n  box-shadow: var(--shadow-1);\\n  resize: none;\\n  outline: none;\\n  z-index: 200;\\n  line-height: 1.2;\\n}\\n/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8uL3NyYy9hcHAvY29tcG9uZW50cy9jYW52YXMvY2FudmFzLmNvbXBvbmVudC5zY3NzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBO0VBQ0UsT0FBQTtFQUNBLGtCQUFBO0VBQ0EsZ0JBQUE7RUFDQSwwQkFBQTtFQUNBLHlKQUNFO0VBRUYsMEJBQUE7QUFGRjs7QUFLQTtFQUNFLFdBQUE7RUFDQSxZQUFBO0VBQ0EsY0FBQTtFQUNBLGlCQUFBO0FBRkY7O0FBS0E7RUFDRSxrQkFBQTtFQUNBLGlCQUFBO0VBQ0EsK0JBQUE7RUFDQSxtQkFBQTtFQUNBLHFDQUFBO0VBQ0Esa0JBQUE7RUFDQSxhQUFBO0VBQ0EsMkJBQUE7RUFDQSxZQUFBO0VBQ0EsYUFBQTtFQUNBLFlBQUE7RUFDQSxnQkFBQTtBQUZGIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbi5jYW52YXMtY29udGFpbmVyIHtcclxuICBmbGV4OiAxO1xyXG4gIHBvc2l0aW9uOiByZWxhdGl2ZTtcclxuICBvdmVyZmxvdzogaGlkZGVuO1xyXG4gIGJhY2tncm91bmQ6IHZhcigtLXN1cmZhY2UpO1xyXG4gIGJhY2tncm91bmQtaW1hZ2U6XHJcbiAgICBsaW5lYXItZ3JhZGllbnQodmFyKC0tZ3JpZC1saW5lLCAjZTBlMGUwKSAxcHgsIHRyYW5zcGFyZW50IDFweCksXHJcbiAgICBsaW5lYXItZ3JhZGllbnQoOTBkZWcsIHZhcigtLWdyaWQtbGluZSwgI2UwZTBlMCkgMXB4LCB0cmFuc3BhcmVudCAxcHgpO1xyXG4gIGJhY2tncm91bmQtc2l6ZTogMjBweCAyMHB4O1xyXG59XHJcblxyXG5jYW52YXMge1xyXG4gIHdpZHRoOiAxMDAlO1xyXG4gIGhlaWdodDogMTAwJTtcclxuICBkaXNwbGF5OiBibG9jaztcclxuICBjdXJzb3I6IGNyb3NzaGFpcjtcclxufVxyXG5cclxuLnRleHQtZWRpdG9yIHtcclxuICBwb3NpdGlvbjogYWJzb2x1dGU7XHJcbiAgcGFkZGluZzogOHB4IDEwcHg7XHJcbiAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tYWNjZW50KTtcclxuICBib3JkZXItcmFkaXVzOiAxMHB4O1xyXG4gIGJhY2tncm91bmQ6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC45NSk7XHJcbiAgY29sb3I6IHZhcigtLXRleHQpO1xyXG4gIGZvbnQ6IGluaGVyaXQ7XHJcbiAgYm94LXNoYWRvdzogdmFyKC0tc2hhZG93LTEpO1xyXG4gIHJlc2l6ZTogbm9uZTtcclxuICBvdXRsaW5lOiBub25lO1xyXG4gIHotaW5kZXg6IDIwMDtcclxuICBsaW5lLWhlaWdodDogMS4yO1xyXG59XHJcbiJdLCJzb3VyY2VSb290IjoiIn0= */\"]\n    });\n  }\n}","map":{"version":3,"names":["Subject","takeUntil","i0","ɵɵelementStart","ɵɵtwoWayListener","CanvasComponent_textarea_3_Template_textarea_ngModelChange_0_listener","$event","ɵɵrestoreView","_r2","ctx_r2","ɵɵnextContext","ɵɵtwoWayBindingSet","editValue","ɵɵresetView","ɵɵlistener","CanvasComponent_textarea_3_Template_textarea_keydown_0_listener","onInlineEditKeydown","CanvasComponent_textarea_3_Template_textarea_blur_0_listener","commitInlineEdit","CanvasComponent_textarea_3_Template_textarea_mousedown_0_listener","stopPropagation","ɵɵelementEnd","ɵɵproperty","ɵɵpureFunction4","_c2","editPosition","top","left","width","height","ɵɵtwoWayProperty","CanvasComponent","constructor","canvasService","toolService","historyService","isDrawing","startPoint","x","y","currentElement","destroy$","isPanning","lastPanPoint","isDraggingSelection","dragStartPoint","dragInitialPositions","isResizing","resizeHandle","resizeStartPoint","resizeInitial","id","handleSize","editingElementId","ngAfterViewInit","initCanvas","setupSubscriptions","render","ngOnDestroy","next","complete","canvas","canvasRef","nativeElement","ctx","getContext","resizeCanvas","elements$","pipe","subscribe","zoom$","pan$","offsetWidth","offsetHeight","handleKeyDown","event","ctrlKey","key","preventDefault","state","undo","setState","redo","deleteSelectedElements","addState","getState","onDoubleClick","point","getCanvasPoint","target","findTopElement","text","startInlineEdit","onMouseDown","tool","currentTool","shouldSnap","snapToGrid","clientX","clientY","handleHit","hitHandle","handle","element","measureElementWidth","measureElementHeight","isSelected","shiftKey","clearSelection","selectElement","startSelectionDrag","generateId","type","strokeColor","fillColor","strokeWidth","fontSize","fontFamily","fontStyle","fontWeight","rotation","points","handleTextInput","onMouseMove","dx","dy","pan","setPan","size","gridSize","updated","elements","map","el","base","Math","round","setElements","find","e","newX","newY","newW","newH","minSize","max","updateElement","push","drawElement","onMouseUp","addElement","onWheel","delta","deltaY","setZoom","zoom","rect","getBoundingClientRect","handleSelection","addToSelection","i","length","isPointInElement","some","p","abs","w","h","min","sort","a","b","zIndex","forEach","selected","bounds","getElementBounds","hs","handles","clearRect","save","translate","scale","drawSelectionHandles","restore","strokeStyle","fillStyle","lineWidth","centerX","centerY","rotate","PI","drawRectangle","drawCircle","drawEllipse","drawLine","drawArrow","drawTriangle","drawStar","drawPolygon","drawFreeDraw","drawText","fillRect","strokeRect","radius","beginPath","arc","fill","stroke","radiusX","radiusY","ellipse","endX","endY","moveTo","lineTo","angle","atan2","headLength","cos","sin","family","style","weight","font","fillText","boxW","measureText","boxH","setTimeout","textEditorRef","focus","cancelInlineEdit","x1","y1","x2","y2","x3","y3","closePath","spikes","outerRadius","innerRadius","sides","ɵɵdirectiveInject","i1","CanvasService","i2","ToolService","i3","HistoryService","selectors","viewQuery","CanvasComponent_Query","rf","CanvasComponent_resize_HostBindingHandler","ɵɵresolveWindow","CanvasComponent_keydown_HostBindingHandler","CanvasComponent_dblclick_HostBindingHandler","CanvasComponent_wheel_HostBindingHandler","CanvasComponent_Template_canvas_mousedown_1_listener","_r1","CanvasComponent_Template_canvas_mousemove_1_listener","CanvasComponent_Template_canvas_mouseup_1_listener","ɵɵtemplate","CanvasComponent_textarea_3_Template","ɵɵadvance"],"sources":["C:\\Users\\vinic\\Desktop\\Estagio\\Teste\\src\\app\\components\\canvas\\canvas.component.ts","C:\\Users\\vinic\\Desktop\\Estagio\\Teste\\src\\app\\components\\canvas\\canvas.component.html"],"sourcesContent":["import { Component, ElementRef, ViewChild, AfterViewInit, HostListener, OnDestroy } from '@angular/core';\r\nimport { Subject, takeUntil } from 'rxjs';\r\nimport { CanvasService } from '../../services/canvas.service';\r\nimport { ToolService } from '../../services/tool.service';\r\nimport { HistoryService } from '../../services/history.service';\r\nimport { DrawingElement, Point, ToolType } from '../../models/drawing.model';\r\n\r\n@Component({\r\n  selector: 'app-canvas',\r\n  templateUrl: './canvas.component.html',\r\n  styleUrls: ['./canvas.component.scss']\r\n})\r\nexport class CanvasComponent implements AfterViewInit, OnDestroy {\r\n  @ViewChild('canvas', { static: false }) canvasRef!: ElementRef<HTMLCanvasElement>;\r\n  @ViewChild('textEditor', { static: false }) textEditorRef?: ElementRef<HTMLTextAreaElement>;\r\n  \r\n  private ctx!: CanvasRenderingContext2D;\r\n  private isDrawing = false;\r\n  private startPoint: Point = { x: 0, y: 0 };\r\n  private currentElement: DrawingElement | null = null;\r\n  private destroy$ = new Subject<void>();\r\n  private isPanning = false;\r\n  private lastPanPoint: Point = { x: 0, y: 0 };\r\n  private isDraggingSelection = false;\r\n  private dragStartPoint: Point | null = null;\r\n  private dragInitialPositions: Record<string, Point> = {};\r\n  private isResizing = false;\r\n  private resizeHandle: 'nw' | 'ne' | 'sw' | 'se' | 'n' | 's' | 'e' | 'w' | null = null;\r\n  private resizeStartPoint: Point | null = null;\r\n  private resizeInitial = { x: 0, y: 0, width: 0, height: 0, id: '' };\r\n  private readonly handleSize = 10;\r\n\r\n  editingElementId: string | null = null;\r\n  editValue = '';\r\n  editPosition = { top: 0, left: 0, width: 140, height: 36 };\r\n\r\n  constructor(\r\n    public canvasService: CanvasService,\r\n    private toolService: ToolService,\r\n    private historyService: HistoryService\r\n  ) {}\r\n\r\n  ngAfterViewInit(): void {\r\n    this.initCanvas();\r\n    this.setupSubscriptions();\r\n    this.render();\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.destroy$.next();\r\n    this.destroy$.complete();\r\n  }\r\n\r\n  private initCanvas(): void {\r\n    const canvas = this.canvasRef.nativeElement;\r\n    this.ctx = canvas.getContext('2d')!;\r\n    this.resizeCanvas();\r\n  }\r\n\r\n  private setupSubscriptions(): void {\r\n    this.canvasService.elements$\r\n      .pipe(takeUntil(this.destroy$))\r\n      .subscribe(() => this.render());\r\n\r\n    this.canvasService.zoom$\r\n      .pipe(takeUntil(this.destroy$))\r\n      .subscribe(() => this.render());\r\n\r\n    this.canvasService.pan$\r\n      .pipe(takeUntil(this.destroy$))\r\n      .subscribe(() => this.render());\r\n  }\r\n\r\n  @HostListener('window:resize')\r\n  private resizeCanvas(): void {\r\n    const canvas = this.canvasRef.nativeElement;\r\n    canvas.width = canvas.offsetWidth;\r\n    canvas.height = canvas.offsetHeight;\r\n    this.render();\r\n  }\r\n\r\n  @HostListener('window:keydown', ['$event'])\r\n  handleKeyDown(event: KeyboardEvent): void {\r\n    if (event.ctrlKey && event.key === 'z') {\r\n      event.preventDefault();\r\n      const state = this.historyService.undo();\r\n      if (state) this.canvasService.setState(state);\r\n    } else if (event.ctrlKey && event.key === 'y') {\r\n      event.preventDefault();\r\n      const state = this.historyService.redo();\r\n      if (state) this.canvasService.setState(state);\r\n    } else if (event.key === 'Delete') {\r\n      event.preventDefault();\r\n      this.canvasService.deleteSelectedElements();\r\n      this.historyService.addState(this.canvasService.getState());\r\n    }\r\n  }\r\n\r\n  @HostListener('dblclick', ['$event'])\r\n  onDoubleClick(event: MouseEvent): void {\r\n    const point = this.getCanvasPoint(event, false);\r\n    const target = this.findTopElement(point);\r\n    if (target && target.text) {\r\n      this.startInlineEdit(target);\r\n    }\r\n  }\r\n\r\n  onMouseDown(event: MouseEvent): void {\r\n    const tool = this.toolService.currentTool;\r\n    const shouldSnap = this.canvasService.snapToGrid && tool !== 'select' && tool !== 'pan';\r\n    const point = this.getCanvasPoint(event, shouldSnap);\r\n\r\n    if (tool === 'pan') {\r\n      this.isPanning = true;\r\n      this.lastPanPoint = { x: event.clientX, y: event.clientY };\r\n      return;\r\n    }\r\n\r\n    // Auto-seleciona elementos mesmo quando outra ferramenta está ativa\r\n    if (tool === 'select') {\r\n      const handleHit = this.hitHandle(point);\r\n      if (handleHit) {\r\n        this.isResizing = true;\r\n        this.resizeHandle = handleHit.handle;\r\n        this.resizeStartPoint = point;\r\n        this.resizeInitial = {\r\n          x: handleHit.element.x,\r\n          y: handleHit.element.y,\r\n          width: handleHit.element.width || this.measureElementWidth(handleHit.element),\r\n          height: handleHit.element.height || this.measureElementHeight(handleHit.element),\r\n          id: handleHit.element.id\r\n        };\r\n        return;\r\n      }\r\n    }\r\n\r\n    if (tool === 'select') {\r\n      const target = this.findTopElement(point);\r\n\r\n      if (target) {\r\n        if (!target.isSelected && !event.shiftKey) {\r\n          this.canvasService.clearSelection();\r\n        }\r\n        this.canvasService.selectElement(target.id, event.shiftKey);\r\n        this.startSelectionDrag(point);\r\n      } else {\r\n        if (!event.shiftKey) {\r\n          this.canvasService.clearSelection();\r\n        }\r\n        this.isDraggingSelection = false;\r\n      }\r\n      return;\r\n    }\r\n\r\n    this.isDrawing = true;\r\n    this.startPoint = point;\r\n    this.canvasService.clearSelection();\r\n\r\n    this.currentElement = {\r\n      id: this.canvasService.generateId(),\r\n      type: tool as Exclude<ToolType, 'select' | 'pan'>,\r\n      x: point.x,\r\n      y: point.y,\r\n      strokeColor: this.toolService.strokeColor,\r\n      fillColor: this.toolService.fillColor,\r\n      strokeWidth: this.toolService.strokeWidth,\r\n      fontSize: this.toolService.fontSize,\r\n      fontFamily: this.toolService.fontFamily,\r\n      fontStyle: this.toolService.fontStyle,\r\n      fontWeight: this.toolService.fontWeight,\r\n      rotation: 0,\r\n      points: tool === 'freedraw' ? [point] : []\r\n    };\r\n\r\n    if (tool === 'text') {\r\n      this.handleTextInput(point);\r\n    }\r\n  }\r\n\r\n  onMouseMove(event: MouseEvent): void {\r\n    if (this.isPanning) {\r\n      const dx = event.clientX - this.lastPanPoint.x;\r\n      const dy = event.clientY - this.lastPanPoint.y;\r\n      const pan = this.canvasService.pan;\r\n      this.canvasService.setPan({ x: pan.x + dx, y: pan.y + dy });\r\n      this.lastPanPoint = { x: event.clientX, y: event.clientY };\r\n      return;\r\n    }\r\n\r\n    if (this.isDraggingSelection && this.dragStartPoint) {\r\n      const point = this.getCanvasPoint(event, this.canvasService.snapToGrid);\r\n      const dx = point.x - this.dragStartPoint.x;\r\n      const dy = point.y - this.dragStartPoint.y;\r\n      const size = this.canvasService.gridSize;\r\n\r\n      const updated = this.canvasService.elements.map(el => {\r\n        if (!el.isSelected) return el;\r\n        const base = this.dragInitialPositions[el.id] || { x: el.x, y: el.y };\r\n        let x = base.x + dx;\r\n        let y = base.y + dy;\r\n        if (this.canvasService.snapToGrid) {\r\n          x = Math.round(x / size) * size;\r\n          y = Math.round(y / size) * size;\r\n        }\r\n        return { ...el, x, y };\r\n      });\r\n\r\n      this.canvasService.setElements(updated);\r\n      this.render();\r\n      return;\r\n    }\r\n\r\n    if (this.isResizing && this.resizeHandle && this.resizeStartPoint) {\r\n      const point = this.getCanvasPoint(event, false);\r\n      const dx = point.x - this.resizeStartPoint.x;\r\n      const dy = point.y - this.resizeStartPoint.y;\r\n      const el = this.canvasService.elements.find(e => e.id === this.resizeInitial.id);\r\n      if (!el) return;\r\n\r\n      let newX = this.resizeInitial.x;\r\n      let newY = this.resizeInitial.y;\r\n      let newW = this.resizeInitial.width || 0;\r\n      let newH = this.resizeInitial.height || 0;\r\n\r\n      const minSize = 10;\r\n      switch (this.resizeHandle) {\r\n        case 'se':\r\n          newW = Math.max(minSize, this.resizeInitial.width + dx);\r\n          newH = Math.max(minSize, this.resizeInitial.height + dy);\r\n          break;\r\n        case 'ne':\r\n          newW = Math.max(minSize, this.resizeInitial.width + dx);\r\n          newH = Math.max(minSize, this.resizeInitial.height - dy);\r\n          newY = this.resizeInitial.y + dy;\r\n          break;\r\n        case 'sw':\r\n          newW = Math.max(minSize, this.resizeInitial.width - dx);\r\n          newH = Math.max(minSize, this.resizeInitial.height + dy);\r\n          newX = this.resizeInitial.x + dx;\r\n          break;\r\n        case 'nw':\r\n          newW = Math.max(minSize, this.resizeInitial.width - dx);\r\n          newH = Math.max(minSize, this.resizeInitial.height - dy);\r\n          newX = this.resizeInitial.x + dx;\r\n          newY = this.resizeInitial.y + dy;\r\n          break;\r\n        case 'e':\r\n          newW = Math.max(minSize, this.resizeInitial.width + dx);\r\n          break;\r\n        case 'w':\r\n          newW = Math.max(minSize, this.resizeInitial.width - dx);\r\n          newX = this.resizeInitial.x + dx;\r\n          break;\r\n        case 's':\r\n          newH = Math.max(minSize, this.resizeInitial.height + dy);\r\n          break;\r\n        case 'n':\r\n          newH = Math.max(minSize, this.resizeInitial.height - dy);\r\n          newY = this.resizeInitial.y + dy;\r\n          break;\r\n      }\r\n\r\n      this.canvasService.updateElement(el.id, { x: newX, y: newY, width: newW, height: newH });\r\n      return;\r\n    }\r\n\r\n    if (!this.isDrawing || !this.currentElement) return;\r\n\r\n    const tool = this.toolService.currentTool;\r\n    const shouldSnap = this.canvasService.snapToGrid && tool !== 'select' && tool !== 'pan';\r\n    const point = this.getCanvasPoint(event, shouldSnap);\r\n\r\n    if (tool === 'freedraw') {\r\n      this.currentElement.points!.push(point);\r\n    } else {\r\n      this.currentElement.width = point.x - this.startPoint.x;\r\n      this.currentElement.height = point.y - this.startPoint.y;\r\n    }\r\n\r\n    this.render();\r\n    if (this.currentElement) {\r\n      this.drawElement(this.currentElement);\r\n    }\r\n  }\r\n\r\n  onMouseUp(event: MouseEvent): void {\r\n    if (this.isPanning) {\r\n      this.isPanning = false;\r\n      return;\r\n    }\r\n\r\n    if (this.isResizing) {\r\n      this.isResizing = false;\r\n      this.resizeHandle = null;\r\n      this.resizeStartPoint = null;\r\n      this.historyService.addState(this.canvasService.getState());\r\n      return;\r\n    }\r\n\r\n    if (this.isDraggingSelection) {\r\n      this.isDraggingSelection = false;\r\n      this.dragStartPoint = null;\r\n      this.dragInitialPositions = {};\r\n      this.historyService.addState(this.canvasService.getState());\r\n      return;\r\n    }\r\n\r\n    if (!this.isDrawing || !this.currentElement) return;\r\n\r\n    if (this.toolService.currentTool !== 'text') {\r\n      this.canvasService.addElement(this.currentElement);\r\n      this.historyService.addState(this.canvasService.getState());\r\n    }\r\n\r\n    this.isDrawing = false;\r\n    this.currentElement = null;\r\n  }\r\n\r\n  @HostListener('wheel', ['$event'])\r\n  onWheel(event: WheelEvent): void {\r\n    if (event.ctrlKey) {\r\n      event.preventDefault();\r\n      const delta = event.deltaY > 0 ? 0.9 : 1.1;\r\n      this.canvasService.setZoom(this.canvasService.zoom * delta);\r\n    }\r\n  }\r\n\r\n  private getCanvasPoint(event: MouseEvent, snapToGrid = false): Point {\r\n    const canvas = this.canvasRef.nativeElement;\r\n    const rect = canvas.getBoundingClientRect();\r\n    const zoom = this.canvasService.zoom;\r\n    const pan = this.canvasService.pan;\r\n\r\n    let x = (event.clientX - rect.left - pan.x) / zoom;\r\n    let y = (event.clientY - rect.top - pan.y) / zoom;\r\n\r\n    if (snapToGrid && this.canvasService.snapToGrid) {\r\n      const size = this.canvasService.gridSize;\r\n      x = Math.round(x / size) * size;\r\n      y = Math.round(y / size) * size;\r\n    }\r\n\r\n    return { x, y };\r\n  }\r\n\r\n  private handleSelection(point: Point, addToSelection: boolean): void {\r\n    const elements = this.canvasService.elements;\r\n    \r\n    for (let i = elements.length - 1; i >= 0; i--) {\r\n      const el = elements[i];\r\n      if (this.isPointInElement(point, el)) {\r\n        this.canvasService.selectElement(el.id, addToSelection);\r\n        return;\r\n      }\r\n    }\r\n\r\n    if (!addToSelection) {\r\n      this.canvasService.clearSelection();\r\n    }\r\n  }\r\n\r\n  private isPointInElement(point: Point, element: DrawingElement): boolean {\r\n    if (element.type === 'freedraw') {\r\n      return element.points?.some(p =>\r\n        Math.abs(p.x - point.x) < 10 && Math.abs(p.y - point.y) < 10\r\n      ) || false;\r\n    }\r\n\r\n    const x = element.x;\r\n    const y = element.y;\r\n    const w = element.width || 0;\r\n    const h = element.height || 0;\r\n\r\n    return point.x >= Math.min(x, x + w) &&\r\n           point.x <= Math.max(x, x + w) &&\r\n           point.y >= Math.min(y, y + h) &&\r\n           point.y <= Math.max(y, y + h);\r\n  }\r\n\r\n  private handleTextInput(point: Point): void {\r\n    if (this.currentElement) {\r\n      const text = '';\r\n      this.currentElement.text = text;\r\n      this.currentElement.width = 100;\r\n      this.currentElement.height = this.measureElementHeight({ ...this.currentElement, text });\r\n      this.canvasService.addElement(this.currentElement);\r\n      this.canvasService.clearSelection();\r\n      this.canvasService.selectElement(this.currentElement.id, false);\r\n      this.startInlineEdit(this.currentElement);\r\n    }\r\n    this.isDrawing = false;\r\n    this.currentElement = null;\r\n  }\r\n\r\n  private findTopElement(point: Point): DrawingElement | null {\r\n    const elements = [...this.canvasService.elements].sort((a, b) => (a.zIndex ?? 0) - (b.zIndex ?? 0));\r\n    for (let i = elements.length - 1; i >= 0; i--) {\r\n      if (this.isPointInElement(point, elements[i])) {\r\n        return elements[i];\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  private startSelectionDrag(point: Point): void {\r\n    this.isDraggingSelection = true;\r\n    this.dragStartPoint = point;\r\n    this.dragInitialPositions = {};\r\n    this.canvasService.elements.forEach(el => {\r\n      if (el.isSelected) {\r\n        this.dragInitialPositions[el.id] = { x: el.x, y: el.y };\r\n      }\r\n    });\r\n  }\r\n\r\n  private hitHandle(point: Point): { element: DrawingElement; handle: 'nw' | 'ne' | 'sw' | 'se' | 'n' | 's' | 'e' | 'w' } | null {\r\n    const selected = this.canvasService.elements.find(el => el.isSelected);\r\n    if (!selected) return null;\r\n    const bounds = this.getElementBounds(selected);\r\n    const hs = this.handleSize;\r\n\r\n    const handles: { handle: 'nw' | 'ne' | 'sw' | 'se' | 'n' | 's' | 'e' | 'w'; x: number; y: number }[] = [\r\n      { handle: 'nw', x: bounds.x - hs / 2, y: bounds.y - hs / 2 },\r\n      { handle: 'n', x: bounds.x + bounds.width / 2 - hs / 2, y: bounds.y - hs / 2 },\r\n      { handle: 'ne', x: bounds.x + bounds.width - hs / 2, y: bounds.y - hs / 2 },\r\n      { handle: 'w', x: bounds.x - hs / 2, y: bounds.y + bounds.height / 2 - hs / 2 },\r\n      { handle: 'e', x: bounds.x + bounds.width - hs / 2, y: bounds.y + bounds.height / 2 - hs / 2 },\r\n      { handle: 'sw', x: bounds.x - hs / 2, y: bounds.y + bounds.height - hs / 2 },\r\n      { handle: 's', x: bounds.x + bounds.width / 2 - hs / 2, y: bounds.y + bounds.height - hs / 2 },\r\n      { handle: 'se', x: bounds.x + bounds.width - hs / 2, y: bounds.y + bounds.height - hs / 2 }\r\n    ];\r\n\r\n    return handles.find(h => point.x >= h.x && point.x <= h.x + hs && point.y >= h.y && point.y <= h.y + hs)\r\n      ? { element: selected, handle: handles.find(h => point.x >= h.x && point.x <= h.x + hs && point.y >= h.y && point.y <= h.y + hs)!.handle }\r\n      : null;\r\n  }\r\n\r\n  private render(): void {\r\n    const canvas = this.canvasRef.nativeElement;\r\n    this.ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n\r\n    this.ctx.save();\r\n    const zoom = this.canvasService.zoom;\r\n    const pan = this.canvasService.pan;\r\n    this.ctx.translate(pan.x, pan.y);\r\n    this.ctx.scale(zoom, zoom);\r\n\r\n    const elements = [...this.canvasService.elements].sort((a, b) => (a.zIndex ?? 0) - (b.zIndex ?? 0));\r\n    elements.forEach(element => {\r\n      this.drawElement(element);\r\n    });\r\n\r\n    const selected = elements.find(el => el.isSelected);\r\n    if (selected) {\r\n      const bounds = this.getElementBounds(selected);\r\n      this.drawSelectionHandles(bounds);\r\n    }\r\n\r\n    this.ctx.restore();\r\n  }\r\n\r\n  private drawElement(element: DrawingElement): void {\r\n    this.ctx.save();\r\n    this.ctx.strokeStyle = element.strokeColor;\r\n    this.ctx.fillStyle = element.fillColor;\r\n    this.ctx.lineWidth = element.strokeWidth;\r\n\r\n    const centerX = element.x + (element.width || 0) / 2;\r\n    const centerY = element.y + (element.height || 0) / 2;\r\n    if (element.rotation) {\r\n      this.ctx.translate(centerX, centerY);\r\n      this.ctx.rotate((element.rotation * Math.PI) / 180);\r\n      this.ctx.translate(-centerX, -centerY);\r\n    }\r\n\r\n    if (element.isSelected) {\r\n      this.ctx.strokeStyle = '#4CAF50';\r\n      this.ctx.lineWidth = element.strokeWidth + 2;\r\n    }\r\n\r\n    switch (element.type) {\r\n      case 'rectangle':\r\n        this.drawRectangle(element);\r\n        break;\r\n      case 'circle':\r\n        this.drawCircle(element);\r\n        break;\r\n      case 'ellipse':\r\n        this.drawEllipse(element);\r\n        break;\r\n      case 'line':\r\n        this.drawLine(element);\r\n        break;\r\n      case 'arrow':\r\n        this.drawArrow(element);\r\n        break;\r\n      case 'triangle':\r\n        this.drawTriangle(element);\r\n        break;\r\n      case 'star':\r\n        this.drawStar(element);\r\n        break;\r\n      case 'polygon':\r\n        this.drawPolygon(element);\r\n        break;\r\n      case 'freedraw':\r\n        this.drawFreeDraw(element);\r\n        break;\r\n      case 'text':\r\n        this.drawText(element);\r\n        break;\r\n    }\r\n\r\n    this.ctx.restore();\r\n  }\r\n\r\n  private drawRectangle(element: DrawingElement): void {\r\n    const w = element.width || 0;\r\n    const h = element.height || 0;\r\n    this.ctx.fillRect(element.x, element.y, w, h);\r\n    this.ctx.strokeRect(element.x, element.y, w, h);\r\n  }\r\n\r\n  private drawCircle(element: DrawingElement): void {\r\n    const radius = Math.abs(element.width || 0) / 2;\r\n    const centerX = element.x + (element.width || 0) / 2;\r\n    const centerY = element.y + (element.height || 0) / 2;\r\n    \r\n    this.ctx.beginPath();\r\n    this.ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);\r\n    this.ctx.fill();\r\n    this.ctx.stroke();\r\n  }\r\n\r\n  private drawEllipse(element: DrawingElement): void {\r\n    const radiusX = Math.abs(element.width || 0) / 2;\r\n    const radiusY = Math.abs(element.height || 0) / 2;\r\n    const centerX = element.x + (element.width || 0) / 2;\r\n    const centerY = element.y + (element.height || 0) / 2;\r\n    \r\n    this.ctx.beginPath();\r\n    this.ctx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, Math.PI * 2);\r\n    this.ctx.fill();\r\n    this.ctx.stroke();\r\n  }\r\n\r\n  private drawLine(element: DrawingElement): void {\r\n    const endX = element.x + (element.width || 0);\r\n    const endY = element.y + (element.height || 0);\r\n    \r\n    this.ctx.beginPath();\r\n    this.ctx.moveTo(element.x, element.y);\r\n    this.ctx.lineTo(endX, endY);\r\n    this.ctx.stroke();\r\n  }\r\n\r\n  private drawArrow(element: DrawingElement): void {\r\n    const endX = element.x + (element.width || 0);\r\n    const endY = element.y + (element.height || 0);\r\n    \r\n    // Draw line\r\n    this.ctx.beginPath();\r\n    this.ctx.moveTo(element.x, element.y);\r\n    this.ctx.lineTo(endX, endY);\r\n    this.ctx.stroke();\r\n\r\n    // Draw arrowhead\r\n    const angle = Math.atan2(endY - element.y, endX - element.x);\r\n    const headLength = 15;\r\n    \r\n    this.ctx.beginPath();\r\n    this.ctx.moveTo(endX, endY);\r\n    this.ctx.lineTo(\r\n      endX - headLength * Math.cos(angle - Math.PI / 6),\r\n      endY - headLength * Math.sin(angle - Math.PI / 6)\r\n    );\r\n    this.ctx.moveTo(endX, endY);\r\n    this.ctx.lineTo(\r\n      endX - headLength * Math.cos(angle + Math.PI / 6),\r\n      endY - headLength * Math.sin(angle + Math.PI / 6)\r\n    );\r\n    this.ctx.stroke();\r\n  }\r\n\r\n  private drawFreeDraw(element: DrawingElement): void {\r\n    if (!element.points || element.points.length < 2) return;\r\n\r\n    this.ctx.beginPath();\r\n    this.ctx.moveTo(element.points[0].x, element.points[0].y);\r\n    \r\n    for (let i = 1; i < element.points.length; i++) {\r\n      this.ctx.lineTo(element.points[i].x, element.points[i].y);\r\n    }\r\n    \r\n    this.ctx.stroke();\r\n  }\r\n\r\n  private drawText(element: DrawingElement): void {\r\n    if (!element.text) return;\r\n    const size = element.fontSize ?? 16;\r\n    const family = element.fontFamily ?? 'Arial';\r\n    const style = element.fontStyle ?? 'normal';\r\n    const weight = element.fontWeight ?? 'normal';\r\n    this.ctx.font = `${style} ${weight} ${size}px ${family}`;\r\n    this.ctx.fillStyle = element.strokeColor || '#000';\r\n    this.ctx.fillText(element.text, element.x, element.y + size);\r\n    \r\n    if (element.isSelected) {\r\n      const boxW = element.width || this.ctx.measureText(element.text).width;\r\n      const boxH = element.height || size;\r\n      this.ctx.strokeRect(element.x - 2, element.y, boxW + 4, boxH + 4);\r\n    }\r\n  }\r\n\r\n  private getElementBounds(el: DrawingElement) {\r\n    if (el.type === 'text') {\r\n      const size = el.fontSize ?? 16;\r\n      const family = el.fontFamily ?? 'Arial';\r\n      const style = el.fontStyle ?? 'normal';\r\n      const weight = el.fontWeight ?? 'normal';\r\n      this.ctx.save();\r\n      this.ctx.font = `${style} ${weight} ${size}px ${family}`;\r\n      const width = el.width || this.ctx.measureText(el.text || '').width;\r\n      this.ctx.restore();\r\n      const height = el.height || size;\r\n      return { x: el.x, y: el.y, width, height };\r\n    }\r\n    return { x: el.x, y: el.y, width: el.width || 0, height: el.height || 0 };\r\n  }\r\n\r\n  private measureElementWidth(el: DrawingElement): number {\r\n    if (el.type === 'text') {\r\n      const size = el.fontSize ?? 16;\r\n      const family = el.fontFamily ?? 'Arial';\r\n      const style = el.fontStyle ?? 'normal';\r\n      const weight = el.fontWeight ?? 'normal';\r\n      this.ctx.save();\r\n      this.ctx.font = `${style} ${weight} ${size}px ${family}`;\r\n      const width = this.ctx.measureText(el.text || '').width;\r\n      this.ctx.restore();\r\n      return width;\r\n    }\r\n    return el.width || 0;\r\n  }\r\n\r\n  private measureElementHeight(el: DrawingElement): number {\r\n    if (el.type === 'text') {\r\n      return el.height || el.fontSize || 16;\r\n    }\r\n    return el.height || 0;\r\n  }\r\n\r\n  private drawSelectionHandles(bounds: { x: number; y: number; width: number; height: number }): void {\r\n    const hs = this.handleSize;\r\n    const handles = [\r\n      { x: bounds.x - hs / 2, y: bounds.y - hs / 2 }, // nw\r\n      { x: bounds.x + bounds.width / 2 - hs / 2, y: bounds.y - hs / 2 }, // n\r\n      { x: bounds.x + bounds.width - hs / 2, y: bounds.y - hs / 2 }, // ne\r\n      { x: bounds.x - hs / 2, y: bounds.y + bounds.height / 2 - hs / 2 }, // w\r\n      { x: bounds.x + bounds.width - hs / 2, y: bounds.y + bounds.height / 2 - hs / 2 }, // e\r\n      { x: bounds.x - hs / 2, y: bounds.y + bounds.height - hs / 2 }, // sw\r\n      { x: bounds.x + bounds.width / 2 - hs / 2, y: bounds.y + bounds.height - hs / 2 }, // s\r\n      { x: bounds.x + bounds.width - hs / 2, y: bounds.y + bounds.height - hs / 2 } // se\r\n    ];\r\n\r\n    this.ctx.save();\r\n    this.ctx.fillStyle = '#4CAF50';\r\n    this.ctx.strokeStyle = '#2e7d32';\r\n    handles.forEach(h => {\r\n      this.ctx.fillRect(h.x, h.y, hs, hs);\r\n      this.ctx.strokeRect(h.x, h.y, hs, hs);\r\n    });\r\n    this.ctx.restore();\r\n  }\r\n\r\n  private startInlineEdit(el: DrawingElement): void {\r\n    const bounds = this.getElementBounds(el);\r\n    const zoom = this.canvasService.zoom;\r\n    const pan = this.canvasService.pan;\r\n\r\n    this.editingElementId = el.id;\r\n    this.editValue = el.text || '';\r\n    this.editPosition = {\r\n      top: bounds.y * zoom + pan.y,\r\n      left: bounds.x * zoom + pan.x,\r\n      width: Math.max(bounds.width, 100) * zoom,\r\n      height: Math.max(bounds.height, el.fontSize || 16) * zoom + 8\r\n    };\r\n\r\n    setTimeout(() => this.textEditorRef?.nativeElement.focus(), 0);\r\n  }\r\n\r\n  commitInlineEdit(): void {\r\n    if (!this.editingElementId) return;\r\n    const target = this.canvasService.elements.find(e => e.id === this.editingElementId);\r\n    if (!target) {\r\n      this.cancelInlineEdit();\r\n      return;\r\n    }\r\n\r\n    const text = this.editValue;\r\n    const width = this.measureElementWidth({ ...target, text });\r\n    const height = this.measureElementHeight({ ...target, text });\r\n    this.canvasService.updateElement(target.id, { text, width, height });\r\n    this.historyService.addState(this.canvasService.getState());\r\n    this.cancelInlineEdit();\r\n  }\r\n\r\n  cancelInlineEdit(): void {\r\n    this.editingElementId = null;\r\n    this.editValue = '';\r\n  }\r\n\r\n  onInlineEditKeydown(event: KeyboardEvent): void {\r\n    if (event.key === 'Enter' && !event.shiftKey) {\r\n      event.preventDefault();\r\n      this.commitInlineEdit();\r\n    }\r\n    if (event.key === 'Escape') {\r\n      event.preventDefault();\r\n      this.cancelInlineEdit();\r\n    }\r\n  }\r\n\r\n  private drawTriangle(element: DrawingElement): void {\r\n    const w = element.width || 0;\r\n    const h = element.height || 0;\r\n    const x1 = element.x + w / 2;\r\n    const y1 = element.y;\r\n    const x2 = element.x + w;\r\n    const y2 = element.y + h;\r\n    const x3 = element.x;\r\n    const y3 = element.y + h;\r\n\r\n    this.ctx.beginPath();\r\n    this.ctx.moveTo(x1, y1);\r\n    this.ctx.lineTo(x2, y2);\r\n    this.ctx.lineTo(x3, y3);\r\n    this.ctx.closePath();\r\n    this.ctx.fill();\r\n    this.ctx.stroke();\r\n  }\r\n\r\n  private drawStar(element: DrawingElement, spikes = 5): void {\r\n    const w = element.width || 0;\r\n    const h = element.height || 0;\r\n    const outerRadius = Math.max(Math.abs(w), Math.abs(h)) / 2;\r\n    const innerRadius = outerRadius / 2.5;\r\n    const centerX = element.x + w / 2;\r\n    const centerY = element.y + h / 2;\r\n\r\n    this.ctx.beginPath();\r\n    for (let i = 0; i < spikes * 2; i++) {\r\n      const radius = i % 2 === 0 ? outerRadius : innerRadius;\r\n      const angle = (Math.PI / spikes) * i - Math.PI / 2;\r\n      const x = centerX + Math.cos(angle) * radius;\r\n      const y = centerY + Math.sin(angle) * radius;\r\n      if (i === 0) {\r\n        this.ctx.moveTo(x, y);\r\n      } else {\r\n        this.ctx.lineTo(x, y);\r\n      }\r\n    }\r\n    this.ctx.closePath();\r\n    this.ctx.fill();\r\n    this.ctx.stroke();\r\n  }\r\n\r\n  private drawPolygon(element: DrawingElement, sides = 6): void {\r\n    if (sides < 3) return;\r\n    const w = element.width || 0;\r\n    const h = element.height || 0;\r\n    const radius = Math.min(Math.abs(w), Math.abs(h)) / 2;\r\n    const centerX = element.x + w / 2;\r\n    const centerY = element.y + h / 2;\r\n\r\n    this.ctx.beginPath();\r\n    for (let i = 0; i < sides; i++) {\r\n      const angle = ((Math.PI * 2) / sides) * i - Math.PI / 2;\r\n      const x = centerX + radius * Math.cos(angle);\r\n      const y = centerY + radius * Math.sin(angle);\r\n      if (i === 0) {\r\n        this.ctx.moveTo(x, y);\r\n      } else {\r\n        this.ctx.lineTo(x, y);\r\n      }\r\n    }\r\n    this.ctx.closePath();\r\n    this.ctx.fill();\r\n    this.ctx.stroke();\r\n  }\r\n}\r\n","<div class=\"canvas-container\">\r\n  <canvas\r\n    #canvas\r\n    (mousedown)=\"onMouseDown($event)\"\r\n    (mousemove)=\"onMouseMove($event)\"\r\n    (mouseup)=\"onMouseUp($event)\"\r\n  ></canvas>\r\n\r\n  <textarea\r\n    *ngIf=\"editingElementId\"\r\n    #textEditor\r\n    class=\"text-editor\"\r\n    [ngStyle]=\"{\r\n      top: editPosition.top + 'px',\r\n      left: editPosition.left + 'px',\r\n      width: editPosition.width + 'px',\r\n      height: editPosition.height + 'px'\r\n    }\"\r\n    [(ngModel)]=\"editValue\"\r\n    (keydown)=\"onInlineEditKeydown($event)\"\r\n    (blur)=\"commitInlineEdit()\"\r\n    (mousedown)=\"$event.stopPropagation()\"\r\n    spellcheck=\"false\"\r\n  ></textarea>\r\n</div>\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}